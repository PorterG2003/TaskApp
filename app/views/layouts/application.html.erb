<!DOCTYPE html>
<html>
  <head>
    <title><%= content_for(:title) || "Task App" %></title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <%= yield :head %>

    <%# Enable PWA manifest for installable apps (make sure to enable in config/routes.rb too!) %>
    <%= tag.link rel: "manifest", href: pwa_manifest_path(format: :json) %>

    <link rel="icon" href="/icon.png" type="image/png">
    <link rel="icon" href="/icon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="/icon.png">

    <%# Includes all stylesheet files in app/assets/stylesheets %>
    <%= stylesheet_link_tag :app, "data-turbo-track": "reload" %>
    <%= stylesheet_link_tag "font-awesome", "data-turbo-track": "reload" %>
    <%= javascript_importmap_tags %>
    
    <!-- Font Awesome CDN as fallback -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
    
    <%# Register service worker for PWA %>
    <script>
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('<%= pwa_service_worker_path %>')
          .then((registration) => console.log('SW registered'))
          .catch((error) => console.log('SW registration failed'));
      }
    </script>
  </head>

  <body class="min-h-screen bg-cover bg-center bg-no-repeat bg-fixed" style="background-image: url('/mountains_bg.jpg');">
    <% if user_signed_in? %>
      <!-- Sidebar Navigation for authenticated users -->
      <div class="flex h-screen" data-controller="sidebar">
        <!-- Sidebar -->
                  <!-- Backdrop -->
          <div class="fixed inset-0 bg-black/30 backdrop-blur-sm transition-opacity duration-300 lg:hidden"
               data-sidebar-target="backdrop"
               data-action="click->sidebar#close">
          </div>

          <!-- Sidebar -->
          <div class="fixed inset-y-0 left-0 z-40 glass-heavy bg-white/20 backdrop-blur-xl border-r border-white/30 flex-shrink-0 transition-all duration-300 ease-in-out transform lg:translate-x-0 lg:static lg:z-auto" 
               data-sidebar-target="sidebar"
               data-action="transitionend->sidebar#onTransitionEnd">
          <div class="flex flex-col h-full">
            <!-- Logo/Brand -->
            <div class="p-6 border-b border-white/20 flex items-center justify-between" data-sidebar-target="brandSection">
              <%= link_to tasks_path, class: "flex items-center" do %>
                <div class="w-10 h-10 glass-heavy bg-blue-600/80 backdrop-blur-xl rounded-xl flex items-center justify-center mr-3 border border-white/30">
                  <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                  </svg>
                </div>
                <span class="text-xl font-bold text-gray-900">TaskApp</span>
              <% end %>
              
              <!-- Toggle Button -->
              <button class="glass-medium bg-white/30 hover:bg-white/50 text-gray-700 p-2 rounded-lg transition duration-200 backdrop-blur-xl border border-white/30"
                      data-action="click->sidebar#toggle">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </button>
            </div>

            <!-- Navigation Links -->
            <div data-sidebar-target="navSection">
              <nav class="flex-1 px-4 py-6 space-y-2">
                <%= link_to tasks_path, class: "glass-medium bg-white/30 hover:bg-white/50 text-gray-700 px-4 py-3 rounded-xl flex items-center transition duration-200 backdrop-blur-xl border border-white/30" do %>
                  <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                  </svg>
                  <span class="font-medium">Tasks</span>
                <% end %>



                <%= link_to "/components", class: "glass-medium bg-white/30 hover:bg-white/50 text-gray-700 px-4 py-3 rounded-xl flex items-center transition duration-200 backdrop-blur-xl border border-white/30" do %>
                  <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zM21 5a2 2 0 00-2-2h-4a2 2 0 00-2 2v12a4 4 0 004 4h4a2 2 0 002-2V5z"></path>
                  </svg>
                  <span class="font-medium">Components</span>
                <% end %>
              </nav>
            </div>

            <!-- User Profile Section -->
            <div class="p-4 border-t border-white/20" data-sidebar-target="userSection">
              <div class="glass-medium bg-white/30 rounded-xl p-4 backdrop-blur-xl border border-white/30">
                <div class="flex items-center mb-3">
                  <%= render Ui::Avatar.new(
                    fallback: current_user.display_name.first.upcase,
                    size: :sm,
                    glass: true
                  ) %>
                  <div class="ml-3">
                    <p class="text-sm font-medium text-gray-900"><%= current_user.display_name %></p>
                    <p class="text-xs text-gray-500"><%= current_user.email %></p>
                  </div>
                </div>
                <%= button_to logout_path, method: :delete, class: "w-full glass-heavy bg-red-500/80 hover:bg-red-600/80 text-white px-3 py-2 rounded-lg text-sm font-medium transition duration-200 backdrop-blur-xl border border-white/30 flex items-center justify-center" do %>
                  <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                  </svg>
                  <span>Sign out</span>
                <% end %>
              </div>
            </div>
          </div>
        </div>

        <!-- Main Content -->
                     <!-- Mobile Header -->
             <div class="fixed top-0 left-0 right-0 lg:hidden z-40" data-sidebar-target="mobileHeader">
               <div class="glass-heavy bg-white/20 backdrop-blur-xl border-b border-white/30 px-4 py-3 flex items-center">
                 <!-- Menu Button -->
                 <button class="glass-heavy bg-white/30 hover:bg-white/50 text-gray-700 w-12 h-12 rounded-xl transition duration-200 backdrop-blur-xl border border-white/30 flex items-center justify-center"
                         data-action="click->sidebar#toggle">
                   <i class="fas fa-bars text-xl"></i>
                 </button>
                 
                 <!-- Title -->
                 <div class="ml-4">
                   <h1 class="text-xl font-bold text-gray-900">TaskApp</h1>
                 </div>
               </div>
             </div>

             <!-- Main Content -->
             <div class="flex-1 flex flex-col overflow-hidden lg:pl-0">
               <main class="flex-1 overflow-y-auto p-4 lg:p-8 mt-20 lg:mt-0">
                 <div class="glass-heavy rounded-3xl p-4 lg:p-8 backdrop-blur-xl bg-white/30 border border-white/40 shadow-2xl">
                   <%= yield %>
                 </div>
               </main>
             </div>
      </div>
    <% else %>
      <%= yield %>
    <% end %>
  </body>
</html>
